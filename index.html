<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TD Schedule</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      background: #111;
      color: white;
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    h1 { margin-top: 20px; font-size: 24px; }
    h2 { font-weight: 400; color: #aaa; margin-top: 5px; margin-bottom: 25px; }
    table {
      width: 90%;
      margin: 0 auto;
      border-collapse: collapse;
      table-layout: fixed;
    }
    td, th {
      border: 2px solid #333;
      padding: 20px;
      text-align: center;
      vertical-align: top;
      width: 14%;
    }
    .left-label {
      width: 8%;
      background: #1c1c1c;
      font-weight: bold;
    }
    .task {
      background: #004aad;
      border-radius: 6px;
      padding: 8px;
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .task span { flex: 1; }
    .task button {
      background: transparent;
      color: #fff;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    .fab {
      position: fixed;
      bottom: 25px;
      right: 25px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      font-size: 30px;
      cursor: pointer;
    }
    #taskModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #222;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      text-align: left;
    }
    .modal-content input, .modal-content textarea {
      width: 100%;
      margin: 5px 0 10px;
      padding: 8px;
      border-radius: 5px;
      border: none;
    }
    .modal-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    .modal-buttons button {
      flex: 1;
      margin: 0 5px;
      padding: 10px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }
    .save-btn { background: #28a745; color: white; }
    .cancel-btn { background: #dc3545; color: white; }
    footer { margin-top: 30px; color: #666; font-size: 14px; }
  </style>
</head>
<body>
  <h1>TD Schedule</h1>
  <h2 id="week-range"></h2>

  <table id="schedule">
    <tr>
      <th></th>
      <th>周一</th><th>周二</th><th>周三</th><th>周四</th><th>周五</th><th>周六</th>
    </tr>
    <tr>
      <td class="left-label">本周上午</td>
      <td colspan="6" id="week1-am"></td>
    </tr>
    <tr>
      <td class="left-label">本周下午</td>
      <td colspan="6" id="week1-pm"></td>
    </tr>
    <tr>
      <td class="left-label">下周上午</td>
      <td colspan="6" id="week2-am"></td>
    </tr>
    <tr>
      <td class="left-label">下周下午</td>
      <td colspan="6" id="week2-pm"></td>
    </tr>
  </table>

  <button class="fab" onclick="openModal()">+</button>

  <div id="taskModal">
    <div class="modal-content">
      <h3>添加任务</h3>
      <input id="date" type="date" />
      <input id="time" type="time" />
      <input id="car" type="text" placeholder="车辆" />
      <input id="mileage" type="text" placeholder="里程" />
      <input id="plate" type="text" placeholder="车牌号" />
      <input id="project" type="text" placeholder="项目" />
      <input id="price" type="number" placeholder="价格" />
      <input id="contact" type="text" placeholder="联系人" />
      <textarea id="note" placeholder="备注"></textarea>
      <div class="modal-buttons">
        <button class="save-btn" onclick="saveTask()">保存</button>
        <button class="cancel-btn" onclick="closeModal()">取消</button>
      </div>
    </div>
  </div>

  <footer>Designed by Shawn</footer>

  <script>
    const supabaseUrl = 'https://mgrorhbschtyrdrekfhb.supabase.co';
    const supabaseKey = 'sb_publishable_bbYg4Bl2F5uHC_3XqdH2RA_NOnp3wfc';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    const modal = document.getElementById('taskModal');

    function openModal() { modal.style.display = 'flex'; }
    function closeModal() { modal.style.display = 'none'; }

    function getWeekRange(date = new Date()) {
      const start = new Date(date);
      start.setDate(date.getDate() - date.getDay() + 1);
      const end = new Date(start);
      end.setDate(start.getDate() + 5);
      const nextStart = new Date(start);
      nextStart.setDate(start.getDate() + 7);
      const nextEnd = new Date(nextStart);
      nextEnd.setDate(nextStart.getDate() + 5);

      const fmt = d => `${d.getMonth() + 1}.${d.getDate()}`;
      document.getElementById('week-range').innerText =
        `本周 ${fmt(start)} - ${fmt(end)}　|　下周 ${fmt(nextStart)} - ${fmt(nextEnd)}`;
    }

    async function loadTasks() {
      const { data: deleted } = await supabaseClient.from('deleted_tasks').select('id');
      const deletedIds = deleted ? deleted.map(d => d.id) : [];

      const { data: tasks } = await supabaseClient.from('tasks').select('*');
      const activeTasks = tasks.filter(t => !deletedIds.includes(t.id));
      renderTasks(activeTasks);
    }

    function renderTasks(tasks) {
      document.querySelectorAll('#schedule td[colspan="6"]').forEach(td => td.innerHTML = '');
      tasks.forEach(task => {
        const d = new Date(task.date);
        const weekday = d.getDay();
        const weekType = isNextWeek(d) ? 'week2' : 'week1';
        const half = task.time < '12:00' ? 'am' : 'pm';
        const cell = document.getElementById(`${weekType}-${half}`);
        if (!cell) return;
        const div = document.createElement('div');
        div.className = 'task';
        div.innerHTML = `<span>${task.time} - ${task.project}</span><button onclick="deleteTask('${task.id}', this)">×</button>`;
        cell.appendChild(div);
      });
    }

    async function deleteTask(id, btn) {
      await supabaseClient.from('deleted_tasks').insert([{ id }]);
      btn.parentElement.remove();
    }

    function isNextWeek(date) {
      const now = new Date();
      const diff = (date - now) / (1000 * 60 * 60 * 24);
      return diff >= 7 && diff < 14;
    }

    async function saveTask() {
      const task = {
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        car: document.getElementById('car').value,
        mileage: document.getElementById('mileage').value,
        plate: document.getElementById('plate').value,
        project: document.getElementById('project').value,
        price: Number(document.getElementById('price').value),
        contact: document.getElementById('contact').value,
        note: document.getElementById('note').value,
      };
      await supabaseClient.from('tasks').insert([task]);
      closeModal();
      loadTasks();
    }

    getWeekRange();
    loadTasks();
  </script>
</body>
</html>
