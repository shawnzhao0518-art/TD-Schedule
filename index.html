<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TD Schedule</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header { text-align: center; margin: 20px 0; }
    h1 { font-size: 28px; margin-bottom: 8px; }
    #subtitle { font-size: 16px; color: #aaa; }

    /* 4×6 网格（左侧标签列 + 6天，4行：本周上/下午、下周上/下午） */
    .schedule {
      display: grid;
      grid-template-columns: 100px repeat(6, 1fr);
      grid-template-rows: repeat(4, 120px);
      gap: 2px;
      width: 95%;
      max-width: 1100px;
      border: 3px solid #444;
      border-radius: 6px;
      overflow: hidden;
      background: #1a1a1a;
    }

    .cell {
      border: 2px solid #333;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      padding: 8px;
      text-align: left;
      font-size: 15px;
      background: #1a1a1a;
      position: relative;
    }

    .header-row {
      display: grid;
      grid-template-columns: 100px repeat(6, 1fr);
      width: 95%;
      max-width: 1100px;
      margin-top: 8px;
      gap: 2px;
    }
    .header-cell {
      border: 2px solid #333;
      background: #222;
      font-weight: bold;
      text-align: center;
      padding: 10px 0;
    }
    .header-cell:first-child { background: transparent; border: none; }

    .time-label {
      font-weight: bold;
      background: #222;
      align-items: center;
      justify-content: center;
      text-align: center;
      display: flex;
    }

    .task {
      cursor: pointer;
      background: #007aff33;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 14px;
      margin: 2px 0;
      width: 100%;
    }

    .add-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      background: #007aff;
      border-radius: 50%;
      color: white;
      font-size: 40px;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    footer { margin: 20px; color: #666; font-size: 14px; }

    .modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.6);
      display: none; justify-content: center; align-items: center;
    }
    .modal-content {
      background: #222; padding: 20px; border-radius: 8px;
      width: 90%; max-width: 420px; line-height: 1.6;
    }
    .delete-btn { background: #d33; border: none; color: #fff; padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-right: 8px; }
    .close-btn { background: #007aff; border: none; color: #fff; padding: 6px 10px; border-radius: 4px; cursor: pointer; }

    /* 添加弹窗表单 */
    #addModal .modal-content form { display: flex; flex-direction: column; gap: 8px; }
    input, textarea {
      width: 100%; background: #333; color: #fff; border: none; border-radius: 4px; padding: 8px;
    }
    #addModal button { margin-top: 10px; }
  </style>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // 配置你的 Supabase
    const supabaseUrl = "https://mgrorhbschtyrdrekfhb.supabase.co";
    const supabaseKey = "sb_publishable_bbYg4Bl2F5uHC_3XqdH2RA_NOnp3wfc";
    const supabase = createClient(supabaseUrl, supabaseKey);

    // ===== 日期/周工具：全部用“日历日期”算法，避免时区造成的星期几错误 =====
    // 把 JS Date → “澳洲悉尼的本地日期字符串” (YYYY-MM-DD)
    function todaySydneyISO() {
      const fmt = new Intl.DateTimeFormat('en-CA', { timeZone: 'Australia/Sydney', year:'numeric', month:'2-digit', day:'2-digit' });
      const parts = fmt.formatToParts(new Date());
      const y = parts.find(p=>p.type==='year').value;
      const m = parts.find(p=>p.type==='month').value;
      const d = parts.find(p=>p.type==='day').value;
      return `${y}-${m}-${d}`; // YYYY-MM-DD
    }
    // 以 ISO（YYYY-MM-DD）为纯日历日期，计算星期几（周一=0..周日=6）
    function weekdayFromISO(iso) {
      const d = new Date(iso + 'T00:00:00Z'); // 以纯日期计算，使用 getUTCDay 保持一致
      const dow = d.getUTCDay(); // 周日=0..周六=6
      return (dow + 6) % 7;      // 转换为 周一=0..周日=6
    }
    // ISO 日期加减天数（返回新的 ISO）
    function addDaysISO(iso, delta) {
      const t = new Date(iso + 'T00:00:00Z').getTime();
      const t2 = t + delta * 86400000;
      const d2 = new Date(t2);
      const y = d2.getUTCFullYear();
      const m = String(d2.getUTCMonth()+1).padStart(2,'0');
      const d = String(d2.getUTCDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    // 求某个 ISO 日期所在周（周一起） 的周一 ISO
    function mondayOfWeekISO(iso) {
      const w = weekdayFromISO(iso); // 周一=0
      return addDaysISO(iso, -w);
    }

    // 顶部副标题：本周 & 下周范围（周一-周六）
    const subtitle = document.getElementById("subtitle");
    (function setSubtitle() {
      const todayISO = todaySydneyISO();
      const thisMon = mondayOfWeekISO(todayISO);
      const thisSat = addDaysISO(thisMon, 5);
      const nextMon = addDaysISO(thisMon, 7);
      const nextSat = addDaysISO(nextMon, 5);
      const fmt = (iso) => {
        const d = new Date(iso + 'T00:00:00Z');
        return `${d.getUTCMonth()+1}.${d.getUTCDate()}`;
      };
      subtitle.textContent = `本周 ${fmt(thisMon)}–${fmt(thisSat)} ｜ 下周 ${fmt(nextMon)}–${fmt(nextSat)}`;
    })();

    // ====== 生成表头（周一～周六）与 4×6 网格 ======
    const days = ["周一","周二","周三","周四","周五","周六"];
    const rows = ["本周上午","本周下午","下周上午","下周下午"];

    const headerRow = document.createElement('div');
    headerRow.className = 'header-row';
    // 左上角空白
    const blank = document.createElement('div'); headerRow.appendChild(blank);
    // 六天标题
    days.forEach(d => {
      const hc = document.createElement('div');
      hc.className = 'header-cell';
      hc.textContent = d;
      headerRow.appendChild(hc);
    });
    document.addEventListener('DOMContentLoaded', () => {
      document.body.insertBefore(headerRow, document.querySelector('.schedule'));
    });

    const schedule = document.querySelector('.schedule');
    schedule.innerHTML = '';
    rows.forEach(rowLabel=>{
      const label = document.createElement('div');
      label.className = 'cell time-label';
      label.textContent = rowLabel;
      schedule.appendChild(label);
      for (let i=0;i<6;i++){
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.row = rowLabel;    // 本周上午/下午/下周上午/下午
        cell.dataset.col = days[i];     // 周一..周六
        schedule.appendChild(cell);
      }
    });

    // ====== 根据任务的“日期 + 时间”放入正确格子 ======
    function placeTaskDom(task) {
      // 任务必须有 date / time
      if (!task.date || !task.time) return;

      // 当前周的周一 ISO
      const todayISO = todaySydneyISO();
      const thisMon = mondayOfWeekISO(todayISO);
      const nextMon = addDaysISO(thisMon, 7);
      const nextNextMon = addDaysISO(thisMon, 14);

      // 任务所属周：本周 or 下周，否则跳过不显示
      let whichWeek = null;
      // 属于本周： [thisMon, nextMon)
      if (task.date >= thisMon && task.date < nextMon) whichWeek = '本周';
      // 属于下周： [nextMon, nextNextMon)
      else if (task.date >= nextMon && task.date < nextNextMon) whichWeek = '下周';
      else return; // 其他周不显示

      // 上午/下午
      const hour = parseInt(String(task.time).split(':')[0] || '0', 10);
      const whichHalf = hour < 12 ? '上午' : '下午';

      // 星期几列（周一=0..周六=5）
      const w = weekdayFromISO(task.date);
      if (w < 0 || w > 5) return; // 周日不显示

      // 行标签
      const rowLabel = `${whichWeek}${whichHalf}`;
      const colLabel = days[w];

      // 找到对应格子
      const cell = Array.from(document.querySelectorAll('.cell'))
        .find(c => c.dataset && c.dataset.row === rowLabel && c.dataset.col === colLabel);
      if (!cell) return;

      // 任务 DOM（收起只显示“时间 + 项目”）
      const div = document.createElement('div');
      div.className = 'task';
      const hhmm = task.time.length >= 5 ? task.time.slice(0,5) : task.time;
      div.textContent = `${hhmm} ${task.project || ''}`;
      div.onclick = () => showTaskDetail(task, div);
      cell.appendChild(div);
    }

    // ====== 加载数据库任务并渲染 ======
    async function loadTasks() {
      const { data, error } = await supabase.from('tasks').select('*').order('date', {ascending:true}).order('time',{ascending:true});
      if (error) { console.error(error); return; }
      // 清空所有非标签格
      Array.from(document.querySelectorAll('.cell')).forEach(c => {
        if (!c.classList.contains('time-label')) c.innerHTML = '';
      });
      (data || []).forEach(placeTaskDom);
    }

    // ====== 任务详情（仅查看 + 页面内删除，不修改数据库） ======
    function showTaskDetail(task, domRef) {
      const modal = document.getElementById('modal');
      modal.style.display = 'flex';
      modal.querySelector('.modal-content').innerHTML = `
        <h3>${task.project || ''}</h3>
        <p><b>日期：</b>${task.date || ''}</p>
        <p><b>时间：</b>${(task.time || '').toString().slice(0,5)}</p>
        <p><b>车名：</b>${task.car || ''}</p>
        <p><b>里程：</b>${task.mileage || ''}</p>
        <p><b>车牌：</b>${task.plate || ''}</p>
        <p><b>价格：</b>${task.price ?? ''}</p>
        <p><b>联系人：</b>${task.contact || ''}</p>
        <p><b>备注：</b>${task.note || ''}</p>
        <button class="delete-btn" id="deleteTemp">删除（仅页面）</button>
        <button class="close-btn" onclick="closeModal()">关闭</button>
      `;
      // 仅移除页面上的这条（不触库）
      document.getElementById('deleteTemp').onclick = () => {
        if (domRef && domRef.remove) domRef.remove();
        closeModal();
      };
    }

    window.closeModal = () => (document.getElementById('modal').style.display = 'none');

    // ====== 添加任务（写入数据库），刷新渲染 ======
    window.addTask = () => (document.getElementById('addModal').style.display = 'flex');
    window.saveTask = async () => {
      const form = document.getElementById('addForm');
      const task = Object.fromEntries(new FormData(form));
      // price numeric 转数字
      if (task.price !== undefined && task.price !== null && task.price !== '') {
        task.price = Number(task.price);
      } else {
        delete task.price;
      }
      const { error } = await supabase.from('tasks').insert([task]);
      if (error) { alert('保存失败：' + error.message); return; }
      document.getElementById('addModal').style.display = 'none';
      form.reset();
      loadTasks();
    };

    // 初始加载
    loadTasks();
  </script>
</head>
<body>
  <header>
    <h1>TD Schedule</h1>
    <div id="subtitle"></div>
  </header>

  <!-- 顶部“周一~周六”标题行由脚本插入 -->
  <div class="schedule"></div>

  <footer>Designed by Shawn</footer>

  <button class="add-btn" onclick="addTask()">+</button>

  <!-- 详情弹窗 -->
  <div id="modal" class="modal">
    <div class="modal-content"></div>
  </div>

  <!-- 添加任务弹窗 -->
  <div id="addModal" class="modal">
    <div class="modal-content">
      <h3>添加任务</h3>
      <form id="addForm">
        <label>日期：</label><input type="date" name="date" required>
        <label>时间：</label><input type="time" name="time" required>
        <label>车型：</label><input type="text" name="car">
        <label>里程：</label><input type="text" name="mileage">
        <label>车牌：</label><input type="text" name="plate">
        <label>项目：</label><input type="text" name="project" required>
        <label>报价：</label><input type="number" name="price" step="0.01">
        <label>联系方式：</label><input type="text" name="contact">
        <label>备注：</label><textarea name="note"></textarea>
      </form>
      <button onclick="saveTask()">保存</button>
      <button onclick="document.getElementById('addModal').style.display='none'">取消</button>
    </div>
  </div>
</body>
</html>
