<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TD Schedule</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      margin: 0;
      background: #0f0f0f;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    header {
      text-align: center;
      padding: 16px;
      background: #141414;
      border-bottom: 1px solid #2a2a2a;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      background: #181818;
    }

    th, td {
      border: 1px solid #333;
      text-align: center;
      vertical-align: top;
      padding: 6px;
    }

    th {
      background: #1d1d1d;
      font-weight: 600;
      color: #eee;
    }

    .label-cell {
      background: #1d1d1d;
      font-weight: bold;
      width: 90px;
    }

    .task {
      background: #2c4370;
      color: #fff;
      margin: 4px 0;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .task button {
      background: none;
      border: none;
      color: #bbb;
      cursor: pointer;
      font-size: 12px;
    }

    footer {
      text-align: center;
      padding: 10px;
      color: #777;
      border-top: 1px solid #2a2a2a;
      background: #141414;
    }

    .add-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      background: #007aff;
      color: #fff;
      font-size: 32px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border: none;
    }

    form {
      position: fixed;
      bottom: 100px;
      right: 24px;
      background: #1e1e1e;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      display: none;
      flex-direction: column;
      gap: 8px;
      width: 280px;
      max-height: 80vh;
      overflow-y: auto;
    }

    form input, form select {
      background: #111;
      color: #fff;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 6px;
      font-size: 14px;
    }

    form button {
      background: #007aff;
      border: none;
      padding: 8px;
      border-radius: 4px;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }

  </style>
</head>
<body>
  <header>
    <h1>TD Schedule</h1>
    <p>本周 · 下周 | 上午 / 下午</p>
  </header>

  <table id="schedule">
    <thead>
      <tr>
        <th></th>
        <th>周一</th>
        <th>周二</th>
        <th>周三</th>
        <th>周四</th>
        <th>周五</th>
        <th>周六</th>
      </tr>
    </thead>
    <tbody id="schedule-body"></tbody>
  </table>

  <footer>Designed by Shawn</footer>

  <button class="add-btn" id="addBtn">+</button>

  <form id="taskForm">
    <h3>添加任务</h3>
    <input type="date" id="date" required>
    <select id="week">
      <option value="本周">本周</option>
      <option value="下周">下周</option>
    </select>
    <select id="time">
      <option value="上午">上午</option>
      <option value="下午">下午</option>
    </select>
    <input type="text" id="car" placeholder="车型" required>
    <input type="text" id="mileage" placeholder="里程">
    <input type="text" id="plate" placeholder="车牌号">
    <input type="text" id="project" placeholder="项目内容">
    <input type="number" id="price" placeholder="报价金额" required>
    <input type="text" id="contact" placeholder="联系方式">
    <input type="text" id="note" placeholder="备注">
    <button type="submit">保存</button>
  </form>

  <script>
    const { createClient } = supabase;
    const supabaseUrl = "https://mgrorhbschtyrdrekfhb.supabase.co";
    const supabaseKey = "sb_publishable_bbYg4Bl2F5uHC_3XqdH2RA_NOnp3wfc";
    const db = createClient(supabaseUrl, supabaseKey);

    const tbody = document.getElementById('schedule-body');
    const addBtn = document.getElementById('addBtn');
    const form = document.getElementById('taskForm');
    const weekSelect = document.getElementById('week');

    function autoSelectWeek() {
      const today = new Date();
      const day = today.getDay();
      weekSelect.value = (day === 0) ? "下周" : "本周";
    }
    autoSelectWeek();

    const weeks = ['本周上午','本周下午','下周上午','下周下午'];
    const days = ['周一','周二','周三','周四','周五','周六'];

    function buildTable() {
      tbody.innerHTML = '';
      weeks.forEach(label => {
        const tr = document.createElement('tr');
        const labelCell = document.createElement('td');
        labelCell.textContent = label;
        labelCell.className = 'label-cell';
        tr.appendChild(labelCell);

        for (let i = 0; i < 6; i++) {
          const td = document.createElement('td');
          td.dataset.week = label.includes('下周') ? '下周' : '本周';
          td.dataset.time = label.includes('上午') ? '上午' : '下午';
          td.dataset.day = days[i];
          td.innerHTML = '&nbsp;';
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      });
    }

    buildTable();

    addBtn.addEventListener('click', () => {
      form.style.display = form.style.display === 'flex' ? 'none' : 'flex';
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const task = {
        date: document.getElementById('date').value,
        week: document.getElementById('week').value,
        time: document.getElementById('time').value,
        car: document.getElementById('car').value,
        mileage: document.getElementById('mileage').value,
        plate: document.getElementById('plate').value,
        project: document.getElementById('project').value,
        price: parseFloat(document.getElementById('price').value),
        contact: document.getElementById('contact').value,
        note: document.getElementById('note').value,
      };

      const { error } = await db.from('tasks').insert([task]);
      if (error) alert('❌ 插入失败: ' + error.message);
      else {
        alert('✅ 添加成功');
        form.reset();
        form.style.display = 'none';
        autoSelectWeek();
        loadTasks();
      }
    });

    async function loadTasks() {
      const { data, error } = await db.from('tasks').select('*');
      if (error) { console.error(error); return; }

      document.querySelectorAll('#schedule td').forEach(td => {
        if (!td.classList.contains('label-cell')) td.innerHTML = '&nbsp;';
      });

      data.forEach(task => {
        const td = Array.from(document.querySelectorAll('#schedule td')).find(
          el => el.dataset.week === task.week &&
                el.dataset.time === task.time &&
                el.dataset.day === (task.day || task.date_day)
        );
        if (td) {
          const el = document.createElement('div');
          el.className = 'task';
          el.innerHTML = `${task.car || '未命名'} ¥${task.price || ''} 
                          <button onclick="deleteTask('${task.id}')">x</button>`;
          td.appendChild(el);
        }
      });
    }

    async function deleteTask(id) {
      const { error } = await db.from('tasks').delete().eq('id', id);
      if (error) alert('❌ 删除失败: ' + error.message);
      else loadTasks();
    }

    loadTasks();
  </script>
</body>
</html>
