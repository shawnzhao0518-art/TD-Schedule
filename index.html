<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TD Schedule</title>
<style>
  body {
    background: #111;
    color: #fff;
    font-family: system-ui, -apple-system, sans-serif;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  header {
    text-align: center;
    margin: 20px 0;
  }

  h1 {
    font-size: 28px;
    margin-bottom: 8px;
  }

  #subtitle {
    font-size: 16px;
    color: #aaa;
  }

  .schedule {
    display: grid;
    grid-template-columns: 100px repeat(6, 1fr);
    grid-template-rows: repeat(4, 120px);
    gap: 2px;
    width: 95%;
    max-width: 1100px;
    border: 3px solid #444;
    border-radius: 6px;
    overflow: hidden;
  }

  .cell {
    border: 2px solid #333;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-size: 15px;
    background: #1a1a1a;
    position: relative;
  }

  .header-cell {
    background: #222;
    font-weight: bold;
  }

  .time-label {
    font-weight: bold;
    background: #222;
  }

  .add-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    background: #007aff;
    border-radius: 50%;
    color: white;
    font-size: 40px;
    border: none;
    cursor: pointer;
  }

  footer {
    margin: 20px;
    color: #666;
    font-size: 14px;
  }

  .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background: #222;
    padding: 20px;
    border-radius: 8px;
    width: 90%;
    max-width: 400px;
  }

  input, textarea {
    width: 100%;
    margin: 5px 0 10px;
    padding: 8px;
    border-radius: 4px;
    border: none;
    background: #333;
    color: #fff;
  }

  button {
    background: #007aff;
    border: none;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
  }

  .delete-btn {
    background: #d33;
  }

  .task {
    cursor: pointer;
    background: #007aff33;
    padding: 4px 6px;
    border-radius: 4px;
  }
</style>
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  const supabaseUrl = "https://mgrorhbschtyrdrekfhb.supabase.co";
  const supabaseKey = "sb_publishable_bbYg4Bl2F5uHC_3XqdH2RA_NOnp3wfc";
  const supabase = createClient(supabaseUrl, supabaseKey);

  const subtitle = document.getElementById("subtitle");
  const grid = document.querySelector(".schedule");
  const modal = document.getElementById("modal");
  const addModal = document.getElementById("addModal");

  function getWeekRange(offsetWeeks = 0) {
    const now = new Date();
    const day = now.getDay() || 7;
    const monday = new Date(now);
    monday.setDate(now.getDate() - day + 1 + 7 * offsetWeeks);
    const sunday = new Date(monday);
    sunday.setDate(monday.getDate() + 5);
    const fmt = (d) => `${d.getMonth() + 1}.${d.getDate()}`;
    return `${fmt(monday)} - ${fmt(sunday)}`;
  }

  subtitle.textContent = `本周 ${getWeekRange(0)} | 下周 ${getWeekRange(1)}`;

  const timeLabels = ["本周上午", "本周下午", "下周上午", "下周下午"];
  const days = ["周一","周二","周三","周四","周五","周六"];

  const schedule = document.querySelector(".schedule");
  schedule.innerHTML = "";

  schedule.appendChild(document.createElement("div")); // 空左上角
  days.forEach(d => {
    const cell = document.createElement("div");
    cell.className = "cell header-cell";
    cell.textContent = d;
    schedule.appendChild(cell);
  });

  timeLabels.forEach(t => {
    const label = document.createElement("div");
    label.className = "cell time-label";
    label.textContent = t;
    schedule.appendChild(label);
    for (let i = 0; i < 6; i++) {
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.row = t;
      cell.dataset.col = days[i];
      schedule.appendChild(cell);
    }
  });

  async function loadTasks() {
    const { data } = await supabase.from("tasks").select("*");
    const cells = document.querySelectorAll(".cell");
    data.forEach(task => {
      const t = new Date(task.date);
      const weekDiff = Math.floor((t - new Date()) / (7 * 24 * 3600 * 1000));
      let rowIndex = weekDiff <= 0 ? (task.time < "12:00:00" ? 0 : 1) : (task.time < "12:00:00" ? 2 : 3);
      const colIndex = t.getDay() - 1;
      if (colIndex >= 0 && colIndex < 6) {
        const idx = 1 + rowIndex * 7 + (colIndex + 1);
        const cell = cells[idx];
        const div = document.createElement("div");
        div.className = "task";
        div.textContent = `${task.time.slice(0,5)} ${task.project}`;
        div.onclick = () => showTaskDetail(task);
        cell.appendChild(div);
      }
    });
  }

  function showTaskDetail(task) {
    const modal = document.getElementById("modal");
    modal.style.display = "flex";
    modal.querySelector(".modal-content").innerHTML = `
      <h3>${task.project}</h3>
      <p><b>时间：</b>${task.date} ${task.time.slice(0,5)}</p>
      <p><b>车名：</b>${task.car}</p>
      <p><b>里程：</b>${task.mileage}</p>
      <p><b>车牌：</b>${task.plate}</p>
      <p><b>价格：</b>${task.price ?? ""}</p>
      <p><b>联系人：</b>${task.contact}</p>
      <p><b>备注：</b>${task.note}</p>
      <button class="delete-btn" onclick="deleteTask('${task.id}')">删除</button>
      <button onclick="closeModal()">关闭</button>
    `;
  }

  window.closeModal = () => (modal.style.display = "none");

  window.deleteTask = async (id) => {
    await supabase.from("tasks").delete().eq("id", id);
    location.reload();
  };

  window.addTask = () => (addModal.style.display = "flex");

  window.saveTask = async () => {
    const form = document.querySelector("#addForm");
    const task = Object.fromEntries(new FormData(form));
    await supabase.from("tasks").insert([task]);
    addModal.style.display = "none";
    location.reload();
  };

  loadTasks();
</script>
</head>
<body>
  <header>
    <h1>TD Schedule</h1>
    <div id="subtitle"></div>
  </header>

  <div class="schedule"></div>

  <footer>Designed by Shawn</footer>

  <button class="add-btn" onclick="addTask()">+</button>

  <div id="modal" class="modal">
    <div class="modal-content"></div>
  </div>

  <div id="addModal" class="modal">
    <div class="modal-content">
      <h3>添加任务</h3>
      <form id="addForm">
        <label>日期：</label><input type="date" name="date" required>
        <label>时间：</label><input type="time" name="time" required>
        <label>车名：</label><input type="text" name="car">
        <label>里程：</label><input type="text" name="mileage">
        <label>车牌：</label><input type="text" name="plate">
        <label>项目：</label><input type="text" name="project" required>
        <label>价格：</label><input type="number" name="price" step="0.01">
        <label>联系人：</label><input type="text" name="contact">
        <label>备注：</label><textarea name="note"></textarea>
      </form>
      <button onclick="saveTask()">保存</button>
      <button onclick="addModal.style.display='none'">取消</button>
    </div>
  </div>
</body>
</html>
