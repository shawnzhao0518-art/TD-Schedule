<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TD Schedule</title>
<style>
body { margin:0; font-family:-apple-system,Segoe UI,Roboto,sans-serif; background:#121212; color:#fff; }
header { text-align:center; padding:16px 0; background:#1e1e1e; }
header h1 { margin:0; font-size:22px; }
#week-range { font-size:14px; color:#bbb; margin-top:4px; }
main { display:grid; grid-template-columns:repeat(6,1fr); grid-template-rows:repeat(2,1fr); gap:2px; padding:6px; }
.day { border:1px solid #2a2a2a; border-radius:4px; background:#181818; display:flex; flex-direction:column; padding:6px; overflow-y:auto; }
.task { background:#2c4370; border-radius:6px; padding:4px; margin-bottom:4px; font-size:13px; cursor:pointer; }
#add-btn { position:fixed; right:24px; bottom:24px; width:64px; height:64px; border-radius:50%; background:#2979ff; color:#fff; font-size:36px; border:none; cursor:pointer; }
#modal, #taskModal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.6); display:none; justify-content:center; align-items:center; z-index:10; }
.modal-content { background:#1e1e1e; border-radius:8px; padding:20px; width:90%; max-width:400px; }
label { display:block; margin-top:8px; font-size:14px; }
input, select, textarea { width:100%; padding:6px; border-radius:4px; border:1px solid #333; background:#222; color:#fff; }
button { margin-top:12px; padding:8px 12px; border:none; border-radius:4px; background:#2979ff; color:#fff; cursor:pointer; }
footer { text-align:center; color:#888; padding:8px 0; background:#1e1e1e; }
@media(max-width:768px){ main{grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(4,1fr);} }
</style>
</head>
<body>
<header>
  <h1>TD Schedule</h1>
  <div id="week-range"></div>
</header>

<main id="schedule"></main>

<button id="add-btn">+</button>

<!-- æ·»åŠ ä»»åŠ¡å¼¹çª— -->
<div id="modal">
  <div class="modal-content">
    <h3>æ·»åŠ ä»»åŠ¡</h3>
    <label>æ—¥æœŸï¼š<input type="date" id="date"></label>
    <label>æ—¶é—´ï¼š<input type="time" id="time"></label>
    <label>è½¦å‹ï¼š<input type="text" id="car"></label>
    <label>é‡Œç¨‹ï¼š<input type="text" id="mileage"></label>
    <label>è½¦ç‰Œï¼š<input type="text" id="plate"></label>
    <label>é¡¹ç›®ï¼š<input type="text" id="project"></label>
    <label>æŠ¥ä»·ï¼š</label>
    <div style="display:flex;gap:6px;">
      <select id="hundreds"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option></select>
      <select id="tens"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option></select>
      <select id="ones"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option></select>
      <span>å…ƒ</span>
    </div>
    <label>è”ç³»æ–¹å¼ï¼š<input type="text" id="contact"></label>
    <label>å¤‡æ³¨ï¼š<textarea id="note"></textarea></label>
    <button id="save">ä¿å­˜</button>
    <button onclick="closeModal()">å–æ¶ˆ</button>
  </div>
</div>

<!-- æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ… -->
<div id="taskModal">
  <div class="modal-content">
    <h3>ä»»åŠ¡è¯¦æƒ…</h3>
    <p id="taskInfo"></p>
    <button id="deleteBtn">ğŸ—‘ åˆ é™¤ä»»åŠ¡</button>
    <button onclick="closeTaskModal()">å…³é—­</button>
  </div>
</div>

<footer>Designed by Shawn</footer>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
const supabaseUrl = 'https://mgrorhbschtyrdrekfhb.supabase.co'
const supabaseKey = 'sb_publishable_bbYg4Bl2F5uHC_3XqdH2RA_NOnp3wfc'
const supabase = createClient(supabaseUrl, supabaseKey)

// åˆå§‹åŒ–ç•Œé¢
const schedule = document.getElementById('schedule')
const modal = document.getElementById('modal')
const weekRange = document.getElementById('week-range')

function getWeekRange(offset=0){
  const now=new Date();const first=now.getDate()-now.getDay()+1+offset*7;
  const start=new Date(now.setDate(first));const end=new Date(now.setDate(first+5));
  return `${start.getMonth()+1}.${start.getDate()} - ${end.getMonth()+1}.${end.getDate()}`
}
weekRange.textContent = `æœ¬å‘¨ ${getWeekRange(0)} ï½œ ä¸‹å‘¨ ${getWeekRange(1)}`

// åŠ è½½ä»»åŠ¡
async function loadTasks(){
  schedule.innerHTML=''
  const days=['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­']
  for(let i=0;i<6;i++){
    const div=document.createElement('div')
    div.className='day'
    div.innerHTML=`<b>${days[i]}</b>`
    schedule.appendChild(div)
  }
  const { data } = await supabase.from('tasks').select('*').order('date')
  data.forEach(task=>{
    const date=new Date(task.date);let index=date.getDay()-1;if(index<0||index>5)return;
    const dayBox=schedule.children[index]
    const el=document.createElement('div')
    el.className='task'; el.dataset.id=task.id
    el.textContent=`${task.time || ''} ${task.project || ''}`
    el.onclick=()=>showTaskDetail(task)
    dayBox.appendChild(el)
  })
}

// æ·»åŠ ä»»åŠ¡
document.getElementById('add-btn').onclick=()=>modal.style.display='flex'
function closeModal(){modal.style.display='none'}

document.getElementById('save').onclick=async()=>{
  const price = parseInt(document.getElementById('hundreds').value)*100 + parseInt(document.getElementById('tens').value)*10 + parseInt(document.getElementById('ones').value)
  const data = {
    date:document.getElementById('date').value,
    time:document.getElementById('time').value,
    car:document.getElementById('car').value,
    mileage:document.getElementById('mileage').value,
    plate:document.getElementById('plate').value,
    project:document.getElementById('project').value,
    price:price.toString(),
    contact:document.getElementById('contact').value,
    note:document.getElementById('note').value,
  }
  const { error } = await supabase.from('tasks').insert([data])
  if(error){alert('âŒ ä¿å­˜å¤±è´¥');console.error(error)} else {alert('âœ… å·²ä¿å­˜');closeModal();loadTasks()}
}

// æŸ¥çœ‹ä¸åˆ é™¤
let currentTaskId=null
function showTaskDetail(task){
  currentTaskId=task.id
  document.getElementById('taskInfo').innerText=
    `${task.date} ${task.time}\n${task.car}\n${task.project}\næŠ¥ä»·ï¼š${task.price} å…ƒ\nå¤‡æ³¨ï¼š${task.note||''}`
  document.getElementById('taskModal').style.display='flex'
}
function closeTaskModal(){document.getElementById('taskModal').style.display='none'}
document.getElementById('deleteBtn').onclick=async()=>{
  if(!currentTaskId)return
  const ok=confirm('ç¡®å®šåˆ é™¤è¯¥ä»»åŠ¡ï¼Ÿ')
  if(!ok)return
  await supabase.from('tasks').delete().eq('id',currentTaskId)
  alert('âœ… å·²åˆ é™¤');closeTaskModal();loadTasks()
}

// åˆå§‹åŒ–
loadTasks()
</script>
</body>
</html>
